# Build stage
FROM golang:1.24-alpine AS build

WORKDIR /src
COPY go.mod go.sum ./
RUN go mod download

COPY api/ ./
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-w -s" -o /app .

# Runtime stage
FROM ubuntu:22.04

# Install runtime dependencies including OpenAI Whisper
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    ffmpeg \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && pip3 install --no-cache-dir yt-dlp openai-whisper

# Create data directory
RUN mkdir -p /data && chmod 755 /data

# Copy binary
COPY --from=build /app /app

EXPOSE 8081

ENTRYPOINT ["/app"]